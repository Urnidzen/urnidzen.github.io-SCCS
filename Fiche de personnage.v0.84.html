<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche SCCS - Lignes Manuscrites (v0.32 Export/Import)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,700&family=Spectral:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Reset Box-sizing */
        * { box-sizing: border-box; }

        /* Configuration A4 stricte */
        @page { size: A4 portrait; margin: 0; }
        
        body { 
            margin: 0; 
            padding: 40px 20px; 
            background-color: #2b2b2b; 
            display: flex; 
            justify-content: center; 
            font-family: 'Cormorant Garamond', serif;
            color: #1c1917; 
            min-height: 100vh;
        }

        /* Wrapper pour le syst√®me d'onglets (positionnement relatif) */
        .layout-wrapper {
            position: relative;
            display: flex;
        }

        /* Conteneur principal A4 */
        .sheet-container {
            width: 210mm; 
            height: 297mm; /* Hauteur fixe A4 */
            padding: 10mm 15mm; 
            background-color: #c5a880;
            background-image: url("https://www.transparenttextures.com/patterns/clean-gray-paper.png");
            background-blend-mode: multiply;
            overflow: hidden; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            position: relative; 
            display: flex;
            flex-direction: column;
            z-index: 10; /* Au-dessus des onglets inactifs */
        }

        /* --- SYST√àME DE CLASSEUR (BINDER) - DROITE --- */
        .binder-sidebar {
            position: absolute;
            right: -42px; /* Positionn√© √† DROITE */
            top: 50px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 5;
            width: 40px;
        }

        .binder-tab {
            width: 40px;
            min-height: 40px;
            background-color: #a68b66; 
            background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png");
            border: 1px solid rgba(43, 29, 14, 0.4);
            border-left: none; /* Pas de bordure √† gauche pour fusionner avec la feuille */
            border-radius: 0 8px 8px 0; /* Arrondi √† droite */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); /* Ombre vers la droite */
            transition: transform 0.2s, background-color 0.2s;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 0;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 10px;
            color: #2b1d0e;
            text-transform: uppercase;
            letter-spacing: 1px;
            user-select: none;
        }

        .binder-tab:hover {
            transform: translateX(3px); /* Bouge vers la droite au survol */
            background-color: #c5a880;
        }

        .binder-tab.active {
            background-color: #c5a880; 
            width: 45px;
            /* L'onglet actif s'√©largit vers la gauche pour chevaucher la feuille */
            margin-left: -5px; 
            box-shadow: none; 
            z-index: 11; /* Au-dessus de la feuille */
            border-left: 1px solid #c5a880; /* Masquer la ligne de s√©paration */
        }

        .binder-tab.add-tab {
            height: 40px;
            writing-mode: horizontal-tb;
            font-size: 24px;
            line-height: 1;
            background-color: #2b2b2b;
            color: #888;
            border: 1px solid #444;
            border-left: 1px solid #444; /* Bordure compl√®te pour le bouton + */
        }
        .binder-tab.add-tab:hover {
            color: #fff;
            background-color: #444;
            transform: translateX(0); /* Pas de mouvement pour le + */
        }

        /* Boutons Actions (Reset & Delete) */
        .header-actions {
            display: flex;
            gap: 5px;
        }
        .btn-action {
            cursor: pointer;
            opacity: 0.4;
            transition: opacity 0.2s, color 0.2s;
            padding: 0 2px;
            font-size: 1.1rem;
        }
        .btn-action:hover { opacity: 1; }
        
        /* Couleurs au survol */
        .btn-reset:hover { color: #ea580c; } /* Orange pour vider */
        .btn-delete:hover { color: #dc2626; } /* Rouge pour supprimer */
        .btn-export:hover { color: #2563eb; } /* Bleu pour sauvegarder */
        .btn-import:hover { color: #16a34a; } /* Vert pour charger */

        /* Impression CORRIG√âE */
        @media print {
            body { 
                background: none; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                padding: 0; 
                height: 297mm; 
                display: block; 
                overflow: hidden; /* √âvite scrollbars */
            }
            .layout-wrapper { 
                display: block; 
                height: 297mm;
            }
            .sheet-container { 
                box-shadow: none; 
                margin: 0; 
                /* CORRECTION : Dimensions fixes en mm et position absolue */
                width: 210mm !important; 
                height: 297mm !important;
                min-height: 297mm;
                position: absolute;
                top: 0;
                left: 0;
                overflow: hidden;
                page-break-after: always; 
                z-index: auto;
            }
            /* Cacher les √©l√©ments d'interface */
            .no-print, .binder-sidebar, .header-actions {
                display: none !important;
            }
        }

        /* Tableaux */
        table { border-collapse: collapse; width: 100%; }
        td { vertical-align: top; }

        /* Polices */
        .font-title { font-family: 'Cinzel', serif; }
        .font-body { font-family: 'Cormorant Garamond', serif; }
        .font-digit { font-family: 'Spectral', serif; }
        
        /* Inputs */
        ::placeholder { color: #525252 !important; opacity: 1; font-style: italic; }
        input, select { color: #0f0a05; }

        /* Stats */
        .stat-digit {
            font-family: 'Spectral', serif !important; 
            font-weight: 700 !important; 
            font-size: 2.2rem !important;
            line-height: 1 !important;
            display: inline-block;
            transform: translateY(1px); 
        }

        .label-cell {
            padding: 4px 0 4px 0;
            border-bottom: 1px solid rgba(43, 29, 14, 0.4);
            vertical-align: baseline; font-size: 0.8rem; font-weight: 800;
            text-transform: uppercase; color: #2b1d0e; white-space: nowrap; font-family: 'Cinzel', serif;
        }

        .value-cell {
            padding: 0 5px 0 0; border-bottom: 1px solid rgba(43, 29, 14, 0.4);
            vertical-align: baseline; width: 50px; text-align: right;
        }

        .clean-input {
            width: 100%; background: transparent; border: none; outline: none;
            text-align: right; font-weight: 700; font-size: 1.6rem; color: #0f0a05;
            font-family: 'Spectral', serif; padding: 0; margin: 0; 
            line-height: 1.2; vertical-align: baseline;
        }
        
        .identity-select {
            appearance: none; background: transparent; border: none;
            border-bottom: 2px solid rgba(60, 30, 0, 0.5); width: 100%;
            font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.2rem;
            color: #0f0a05; padding: 0; height: 30px; vertical-align: bottom;
            border-radius: 0;
        }

        .identity-input {
            appearance: none; background: transparent; border: none;
            border-bottom: 2px solid rgba(60, 30, 0, 0.5); width: 100%;
            font-family: 'Spectral', serif; font-weight: 700; font-size: 1.2rem;
            color: #0f0a05; padding: 0; height: 30px; vertical-align: bottom;
            border-radius: 0;
        }

        .check-box {
            width: 20px; height: 20px; border: 2px solid #0f0a05;
            display: inline-flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.3); margin-right: 8px; cursor: pointer;
            vertical-align: middle; 
        }
        .check-box.active { background: #0f0a05; }
        .check-box.active::after { content: "‚úì"; color: #fff; font-size: 16px; line-height: 1; }

        /* Zones de texte FIXES (45mm) */
        .area-textarea {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(43, 29, 14, 0.3);
            width: 100%; 
            height: 50mm; 
            resize: none; 
            padding: 0 8px;
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
            font-size: 1.2rem;
            color: #0f0a05;
            line-height: 30px;
            background-image: linear-gradient(transparent 29px, rgba(43, 29, 14, 0.2) 30px);
            background-size: 100% 30px;
            background-attachment: local;
            display: block;
            margin-top: 4px;
            overflow: hidden;
        }

        /* Espacement standard */
        .spacer-row { height: 5px; } 
        
        .box-cell {
            border: 2px solid rgba(28, 25, 23, 0.3);
            background-color: rgba(255,255,255,0.1);
            border-radius: 4px; padding: 10px;
        }
        
        /* Footer Absolu */
        .footer-absolute {
            position: absolute;
            bottom: 10mm; 
            left: 15mm;    
            right: 15mm;   
            height: 20px;
            text-align: center;
        }
        
        /* Style Image Portrait Custom */
        .portrait-img-custom {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Remplit le cadre sans d√©former */
            /* Petit filtre pour mieux int√©grer une image couleur sur le parchemin */
            filter: sepia(0.2) contrast(1.1) brightness(0.9);
            mix-blend-mode: multiply; /* Rend le blanc transparent et incruste l'image */
        }

        @media (max-width: 215mm) {
            body {
                justify-content: flex-start;
                align-items: flex-start;
                overflow-x: auto;
                height: auto;
            }
            .layout-wrapper { margin-right: 50px; } /* Espace pour les onglets sur mobile */
        }
    </style>
</head>
<body class="font-body text-stone-950">

    <div class="layout-wrapper">
        <!-- ONGLETS LAT√âRAUX (BINDER) - √Ä DROITE -->
        <div id="binder-sidebar" class="binder-sidebar">
            <!-- Rempli par JS -->
            <!-- Bouton + int√©gr√© √† la fin de la liste JS -->
        </div>

        <!-- INPUT FICHIER CACH√â POUR IMPORT -->
        <input type="file" id="file-upload" style="display:none" accept=".json" onchange="handleFileUpload(this)">

        <div class="sheet-container">
            <!-- TABLEAU MA√éTRE -->
            <table style="width: 100%;">
                
                <!-- 1. HEADER - HAUTEUR FIXE 175PX -->
                <tr style="height: 175px;">
                    <td style="width: 160px; padding-right: 25px;">
                        <!-- TABLE PORTRAIT : Height fixe 175px -->
                        <table style="width:100%; height:175px; border: 4px solid rgba(28, 25, 23, 0.6);">
                            <tr>
                                <td style="padding:4px;">
                                    <!-- CONTAINER PORTRAIT DYNAMIQUE -->
                                    <div id="portrait-container" style="width:100%; height:100%; border: 2px dashed rgba(28, 25, 23, 0.4); display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                        <!-- Le SVG ou l'image sera inject√© ici par JS -->
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </td>
                    
                    <td style="vertical-align: bottom;">
                        <table style="height: 100%;">
                            <tr>
                                <td colspan="3" style="vertical-align: top;">
                                    <div class="flex justify-between items-end">
                                        <label class="block text-xs font-black uppercase tracking-[0.3em] font-title text-stone-900">Nom du personnage</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="text" id="char-name" class="w-full bg-transparent border-b-4 border-stone-900/60 text-4xl font-black py-1 font-title outline-none text-black placeholder-stone-600" placeholder="" oninput="updateProfileName(this.value)">
                                        
                                        <!-- ACTIONS (RESET, DELETE, EXPORT, IMPORT) -->
                                        <div class="header-actions ml-2">
                                            <!-- Boutons existants -->
                                            <button onclick="resetSheet()" class="btn-action btn-reset" title="Vider les champs (Garder le personnage)">‚Ü∫</button>
                                            <button onclick="deleteCurrentProfile()" class="btn-action btn-delete" title="Supprimer d√©finitivement ce personnage">üóëÔ∏è</button>
                                            
                                            <!-- Nouveaux Boutons -->
                                            <span style="color:#aaa; font-size:1.1rem; cursor:default;">|</span> <!-- S√©parateur visuel -->
                                            <button onclick="exportBackup()" class="btn-action btn-export" title="Sauvegarder dans un fichier (Export)">üíæ</button>
                                            <button onclick="triggerImport()" class="btn-action btn-import" title="Charger depuis un fichier (Import)">üìÇ</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr style="height: 50px;">
                                <td style="padding-right: 15px; vertical-align: bottom;">
                                    <label class="block text-[9px] font-black uppercase tracking-widest mb-1 font-title text-stone-800">Esp√®ce</label>
                                    <!-- Ajout updatePortrait() -->
                                    <select id="race-select" class="identity-select" onchange="updateRace(); updatePortrait()">
                                        <option value="HUMAIN">HUMAIN</option>
                                        <option value="ELFE">ELFE</option>
                                        <option value="NAIN">NAIN</option>
                                        <option value="ORQUE">ORQUE</option>
                                    </select>
                                </td>
                                <td style="padding-right: 15px; vertical-align: bottom;">
                                    <label class="block text-[9px] font-black uppercase tracking-widest mb-1 font-title text-stone-800">Genre</label>
                                    <!-- Ajout ID et onchange -->
                                    <select id="gender-select" class="identity-select" onchange="updatePortrait()">
                                        <option value="MASCULIN">MASCULIN</option>
                                        <option value="F√âMININ">F√âMININ</option>
                                    </select>
                                </td>
                                <td style="width: 70px; vertical-align: bottom;">
                                    <label class="block text-[9px] font-black uppercase tracking-widest mb-1 font-title text-stone-800">PA</label>
                                    <input type="number" id="val-pa" class="identity-input text-left" value="0">
                                </td>
                            </tr>
                            <tr>
                                <td colspan="3" style="padding-top: 15px;">
                                    <table>
                                        <tr>
                                            <td class="text-[10px] font-bold w-28 py-1 align-baseline border-b border-black/30 text-stone-800">COULEUR DES YEUX:</td>
                                            <td class="border-b border-black/30"><input type="text" id="identity-eyes" class="w-full bg-transparent outline-none italic font-bold placeholder-stone-500" placeholder=""></td>
                                        </tr>
                                        <tr>
                                            <td class="text-[10px] font-bold w-28 py-1 align-baseline border-b border-black/30 text-stone-800">CHEVEUX:</td>
                                            <td class="border-b border-black/30"><input type="text" id="identity-hair" class="w-full bg-transparent outline-none italic font-bold placeholder-stone-500" placeholder=""></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>

                <tr class="spacer-row"><td></td><td></td></tr>

                <!-- 2. SECTION COMBAT -->
                <tr>
                    <td colspan="2">
                        <table style="table-layout: fixed;">
                            <tr>
                                <!-- ATTAQUE -->
                                <td style="width: 48%; padding-right: 2%;">
                                    <h2 class="font-title text-xl font-black uppercase border-l-4 border-stone-900 pl-3 mb-2 text-stone-950">‚öîÔ∏è Attaque</h2>
                                    <table style="width:100%; border:1px solid rgba(28, 25, 23, 0.3); background-color: rgba(0,0,0,0.05); border-radius:4px;">
                                        <tr>
                                            <td style="padding:10px;">
                                                <table style="table-layout: fixed;">
                                                    <tr>
                                                        <td style="padding-right: 15px;">
                                                            <p class="text-[9px] font-black uppercase mb-1 border-b border-black/40 text-stone-900">Type</p>
                                                            <table>
                                                                <tr style="height: 34px;"><td class="label-cell">Direct</td><td class="value-cell"><input type="number" class="clean-input" value="0"></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell">Circulaire</td><td class="value-cell"><input type="number" class="clean-input" value="0"></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell">Saisie</td><td class="value-cell"><input type="number" id="stat-att-saisie" class="clean-input" value="0"></td></tr>
                                                            </table>
                                                        </td>
                                                        <td>
                                                            <p class="text-[9px] font-black uppercase mb-1 border-b border-black/40 text-stone-900">Cible</p>
                                                            <table>
                                                                <tr style="height: 34px;"><td class="label-cell">T√™te</td><td class="value-cell"><input type="number" class="clean-input" value="0"></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell">Tronc</td><td class="value-cell"><input type="number" id="stat-att-tronc" class="clean-input" value="0"></td></tr>
                                                                <tr style="height: 34px;"><td class="label-cell">Membres</td><td class="value-cell"><input type="number" class="clean-input" value="0"></td></tr>
                                                            </table>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                                
                                <!-- PROTECTION -->
                                <td style="width: 48%; padding-left: 2%;">
                                    <h2 class="font-title text-xl font-black uppercase border-l-4 border-stone-900 pl-3 mb-2 text-stone-950">üõ°Ô∏è Protection</h2>
                                    <table style="width:100%; border:1px solid rgba(28, 25, 23, 0.3); background-color: rgba(0,0,0,0.05); border-radius:4px;">
                                        <tr>
                                            <td style="padding:10px;">
                                                <table style="table-layout: fixed; width: 100%;">
                                                    <tr>
                                                        <!-- BLOC TECHNIQUE / D√âFENSE -->
                                                        <td style="padding-right: 15px; vertical-align: top;">
                                                            <div class="flex items-end border-b border-black/40 mb-1" style="height: 15px;">
                                                                <div class="text-[9px] font-black uppercase text-stone-900 flex-grow">D√©fense</div>
                                                            </div>
                                                            <table style="width: 100%;">
                                                                <tr style="height: 34px;">
                                                                    <td class="label-cell">
                                                                        <span style="font-size:0.7em; margin-right:1px;">vs</span> Direct
                                                                    </td>
                                                                    <td class="value-cell"><input type="number" class="clean-input" value="0"></td>
                                                                </tr>
                                                                <tr style="height: 34px;">
                                                                    <td class="label-cell">
                                                                        <span style="font-size:0.7em; margin-right:1px;">vs</span> Circu.
                                                                    </td>
                                                                    <td class="value-cell"><input type="number" class="clean-input" value="0"></td>
                                                                </tr>
                                                                <tr style="height: 34px;">
                                                                    <td class="label-cell">
                                                                        <span style="font-size:0.7em; margin-right:1px;">vs</span> Saisie
                                                                    </td>
                                                                    <td class="value-cell"><input type="number" class="clean-input" value="0"></td>
                                                                </tr>
                                                            </table>
                                                        </td>
                                                        
                                                        <!-- BLOC R√âSISTANCE -->
                                                        <td style="vertical-align: top;">
                                                            <div class="flex items-end border-b border-black/40 mb-1" style="height: 15px;">
                                                                <div class="text-[9px] font-black uppercase text-stone-900 flex-grow">R√©sistance</div>
                                                                <div class="text-[8px] font-black uppercase text-stone-600 text-center w-[32px] pb-[1px]">Nat.</div>
                                                                <div class="text-[8px] font-black uppercase text-stone-600 text-center w-[38px] pb-[1px]">Arm.</div>
                                                            </div>

                                                            <table style="width: 100%;">
                                                                <colgroup>
                                                                    <col> <!-- Label -->
                                                                    <col style="width: 32px;"> <!-- Nat -->
                                                                    <col style="width: 38px;"> <!-- Bonus -->
                                                                </colgroup>
                                                                <tr style="height: 34px;">
                                                                    <td class="label-cell">T√™te</td>
                                                                    <td class="value-cell" style="padding-right: 2px;">
                                                                        <input type="number" id="res-nat-tete" class="clean-input" value="0">
                                                                    </td>
                                                                    <td style="border-bottom: 1px solid rgba(43, 29, 14, 0.4); vertical-align: bottom; text-align: left; padding-left: 2px; white-space: nowrap;">
                                                                        <span class="font-digit font-bold text-[#0f0a05] text-[1.6rem] leading-[1.2] align-baseline">+</span><span id="res-arm-tete" class="font-digit font-bold text-[#0f0a05] text-[1.6rem] leading-[1.2] align-baseline">0</span>
                                                                    </td>
                                                                </tr>
                                                                <tr style="height: 34px;">
                                                                    <td class="label-cell">Tronc</td>
                                                                    <td class="value-cell" style="padding-right: 2px;">
                                                                        <input type="number" id="res-nat-tronc" class="clean-input" value="0">
                                                                    </td>
                                                                    <td style="border-bottom: 1px solid rgba(43, 29, 14, 0.4); vertical-align: bottom; text-align: left; padding-left: 2px; white-space: nowrap;">
                                                                        <span class="font-digit font-bold text-[#0f0a05] text-[1.6rem] leading-[1.2] align-baseline">+</span><span id="res-arm-tronc" class="font-digit font-bold text-[#0f0a05] text-[1.6rem] leading-[1.2] align-baseline">0</span>
                                                                    </td>
                                                                </tr>
                                                                <tr style="height: 34px;">
                                                                    <td class="label-cell">Membres</td>
                                                                    <td class="value-cell" style="padding-right: 2px;">
                                                                        <input type="number" id="res-nat-membres" class="clean-input" value="0">
                                                                    </td>
                                                                    <td style="border-bottom: 1px solid rgba(43, 29, 14, 0.4); vertical-align: bottom; text-align: left; padding-left: 2px; white-space: nowrap;">
                                                                        <span class="font-digit font-bold text-[#0f0a05] text-[1.6rem] leading-[1.2] align-baseline">+</span><span id="res-arm-membres" class="font-digit font-bold text-[#0f0a05] text-[1.6rem] leading-[1.2] align-baseline">0</span>
                                                                    </td>
                                                                </tr>
                                                            </table>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>

                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>

                <tr class="spacer-row"><td></td><td></td></tr>

                <!-- 3. √âQUIPEMENT & TALENTS -->
                <tr>
                    <td colspan="2">
                        <table style="table-layout: fixed;">
                            <tr>
                                <!-- COLONNE ARSENAL (GAUCHE) -->
                                <td style="width: 48%; padding-right: 2%;">
                                    
                                    <!-- BLOC 1: ARME -->
                                    <table style="width:100%; margin-bottom: 12px;">
                                        <tr>
                                            <td class="box-cell">
                                                <table style="width:100%;">
                                                    <tr>
                                                        <td>
                                                            <label class="block text-[9px] font-black uppercase text-stone-700">Arme</label>
                                                            <!-- Select vid√©, rempli par JS -->
                                                            <select id="weapon-select" class="w-full bg-transparent font-title font-bold text-lg border-b border-black/40 outline-none text-black" onchange="updateUI()">
                                                            </select>
                                                        </td>
                                                    </tr>
                                                    <!-- Ligne MAIN GAUCHE (Nouvelle) -->
                                                    <tr>
                                                        <td style="padding-top: 5px;">
                                                            <label class="block text-[9px] font-black uppercase text-stone-700">Main Gauche</label>
                                                            <select id="offhand-select" class="w-full bg-transparent font-title font-bold text-base border-b border-black/40 outline-none text-black" onchange="updateUI()">
                                                                <!-- Rempli par JS en fonction de l'arme -->
                                                            </select>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style="padding-top: 8px;">
                                                            <table style="width:100%; border-top: 1px solid rgba(0,0,0,0.2); padding-top: 4px;">
                                                                <tr>
                                                                    <td class="font-title font-bold uppercase text-xs align-middle text-stone-800">
                                                                        Initiative
                                                                    </td>
                                                                    <td style="text-align: right; vertical-align: middle;">
                                                                        <span class="text-[10px] uppercase font-bold mr-2 text-stone-600 align-middle">Prio.</span>
                                                                    </td>
                                                                    <!-- TD wrapper neutre -->
                                                                    <td style="text-align: right; vertical-align: middle;">
                                                                        <!-- SPAN CIBLE PAR JS -->
                                                                        <span id="init-val" class="stat-digit" style="color: #0f0a05;">5</span>
                                                                    </td>
                                                                </tr>
                                                            </table>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>

                                    <!-- BLOC 2: PROTECTION -->
                                    <table style="width:100%; margin-bottom: 12px;">
                                        <tr>
                                            <td class="box-cell">
                                                <table style="width:100%;">
                                                    <tr>
                                                        <td>
                                                            <label class="block text-[9px] font-black uppercase text-stone-700">Protection</label>
                                                            <select id="armor-select" class="w-full bg-transparent font-title font-bold text-base border-b border-black/40 outline-none text-black" onchange="updateUI()">
                                                                <option value="Aucune">Sans Armure</option>
                                                                <option value="L√©g√®re">Cuir sans Heaume</option>
                                                                <option value="L√©g√®re_Heaume">Cuir avec Heaume</option>
                                                                <option value="Moyenne">Mailles sans Heaume</option>
                                                                <option value="Moyenne_Heaume">Mailles avec Heaume</option>
                                                                <option value="Lourde">Harnois sans Heaume</option>
                                                                <option value="Lourde_Heaume">Harnois avec Heaume</option>
                                                            </select>
                                                        </td>
                                                        <td class="text-right w-20">
                                                            <label class="block text-[9px] font-black uppercase text-stone-700">Dura.</label>
                                                            <span id="dur-display" class="text-xl font-black text-black">0/0</span>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>
                                    
                                    <!-- BLOC 3: MALUS MAGIE (Distinct) -->
                                    <table style="width:100%;">
                                        <tr>
                                            <td class="box-cell">
                                                <!-- NOUVELLE TABLE MALUS MAGIE VISIBLE (Fixe) -->
                                                <table style="width:100%; table-layout: fixed;">
                                                    <colgroup>
                                                        <col style="width: auto;">
                                                        <col style="width: 35px;">
                                                    </colgroup>
                                                    <tr>
                                                        <td colspan="2" style="padding-bottom: 6px;">
                                                            <div class="font-title font-black uppercase text-sm text-stone-900 tracking-wide">Malus Magie</div>
                                                        </td>
                                                    </tr>
                                                    <!-- Ligne ARME (Dynamique) -->
                                                    <tr style="height: 40px;"> <!-- Hauteur fixe -->
                                                        <td style="vertical-align: middle; padding-bottom: 6px; overflow: hidden;">
                                                            <!-- TEXTE INJECT√â PAR JS -->
                                                            <div id="magic-weapon-text" class="font-bold text-[10px] uppercase text-stone-900 leading-tight pr-1">
                                                                
                                                            </div>
                                                        </td>
                                                        <td style="text-align: right; vertical-align: middle;">
                                                            <span id="magie-arme-val" class="font-digit font-black text-xl text-stone-900">0</span>
                                                        </td>
                                                    </tr>
                                                    
                                                    <!-- Ligne ARMURE (Avec ID pour masquage) -->
                                                    <tr id="row-malus-armure" style="height: 40px;"> <!-- Hauteur fixe -->
                                                        <td style="vertical-align: middle;">
                                                            <div class="font-bold text-[10px] uppercase text-stone-900 leading-tight">Malus d√ª au port d'une armure</div>
                                                            <div class="text-[10px] font-black text-stone-900 italic leading-tight uppercase">Uniquement si cible hostile</div>
                                                        </td>
                                                        <td style="text-align: right; vertical-align: middle;">
                                                            <span id="magie-armure-val" class="font-digit font-black text-xl text-stone-900">0</span>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>

                                </td>

                                <!-- TALENTS (DROITE) -->
                                <td style="width: 48%; padding-left: 2%; border-left: 2px solid rgba(45,26,10,0.2); vertical-align: top;">
                                    <h2 class="font-title text-sm font-black uppercase border-b-2 border-stone-900/40 pb-1 mb-2 text-stone-950">Talents</h2>
                                    <div id="talents-container"></div>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>

                <tr class="spacer-row"><td></td><td></td></tr>

                <!-- 4. NOTES (Fusionn√©) -->
                <tr>
                    <td colspan="2">
                        <div style="width: 100%;">
                            <h3 class="font-title text-xs font-black uppercase mb-1 text-stone-900">Notes</h3>
                            <textarea class="area-textarea"></textarea>
                        </div>
                    </td>
                </tr>
            </table>
            
            <!-- FOOTER (Hors du tableau pour position absolue fiable) -->
            <div class="footer-absolute">
                <div class="text-[9px] text-center text-stone-800 uppercase font-black tracking-widest pt-1 border-t border-black/30 mt-1">
                    Grimoire SCCS VLU Officiel - Fiche Personnage
                </div>
            </div>
        </div>
    </div>

    <script>
        const CUSTOM_PORTRAITS_URLS = {
            "HUMAIN_MASCULIN": "https://umidzen.github.io/SCCS/portraits/Portrait homme Humain.png",
            "HUMAIN_F√âMININ": "https://umidzen.github.io/SCCS/portraits/Portrait femme Humain.png",
            "ELFE_MASCULIN": "https://umidzen.github.io/SCCS/portraits/Portrait homme Elfe.png",
            "ELFE_F√âMININ": "https://umidzen.github.io/SCCS/portraits/Portrait femme Elfe.png",
            "NAIN_MASCULIN": "https://umidzen.github.io/SCCS/portraits/Portrait homme Nain.png",
            "NAIN_F√âMININ": "https://umidzen.github.io/SCCS/portraits/Portrait femme Nain.png",
            "ORQUE_MASCULIN": "https://umidzen.github.io/SCCS/portraits/Portrait homme Orque.png",
            "ORQUE_F√âMININ": "https://umidzen.github.io/SCCS/portraits/Portrait femme Orque.png",
        };

        const state = {
            talents: {
                athletisme: false, acrobatie: false, mecanique: false,
                subtilite: false, perception: false, survie: false,
                savoir_acad: false
            },
            currentWeaponCategory: "Courte"
        };

        // --- GESTION DU CLASSEUR ET DE LA SAUVEGARDE ---
        const BINDER_STORAGE_KEY = 'sccs_binder_data_v2';
        let binderData = {
            activeId: null,
            profiles: {}
        };

        function initBinder() {
            // Charger les donn√©es
            const stored = localStorage.getItem(BINDER_STORAGE_KEY);
            if (stored) {
                try {
                    binderData = JSON.parse(stored);
                } catch(e) { console.error("Erreur lecture sauvegarde", e); }
            }

            // Si aucun profil, en cr√©er un par d√©faut
            if (Object.keys(binderData.profiles).length === 0) {
                const defaultId = 'p_' + Date.now();
                binderData.profiles[defaultId] = { name: "Nouveau", data: {} };
                binderData.activeId = defaultId;
                saveBinderData();
            }

            // Si l'ID actif n'existe plus, prendre le premier
            if (!binderData.profiles[binderData.activeId]) {
                binderData.activeId = Object.keys(binderData.profiles)[0];
                saveBinderData();
            }

            renderTabs();
            loadProfile(binderData.activeId);
            
            // √âcouteur global pour la sauvegarde auto sur TOUS les inputs
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('input', () => autoSaveCurrentProfile());
                el.addEventListener('change', () => autoSaveCurrentProfile());
            });
        }

        function saveBinderData() {
            localStorage.setItem(BINDER_STORAGE_KEY, JSON.stringify(binderData));
        }

        function renderTabs() {
            const sidebar = document.getElementById('binder-sidebar');
            sidebar.innerHTML = ''; // Clear tabs
            
            Object.keys(binderData.profiles).forEach(id => {
                const profile = binderData.profiles[id];
                const isActive = (id === binderData.activeId);
                const tab = document.createElement('div');
                tab.className = `binder-tab ${isActive ? 'active' : ''}`;
                tab.innerText = profile.name || "Nouveau";
                // Clic simple : change d'onglet
                tab.onclick = () => handleTabClick(id, isActive);
                sidebar.appendChild(tab);
            });
            
            // Bouton Ajout Direct (+)
            const addBtn = document.createElement('div');
            addBtn.className = "binder-tab add-tab";
            addBtn.innerText = "+";
            addBtn.title = "Cr√©er un nouveau personnage";
            addBtn.onclick = createNewProfile;
            sidebar.appendChild(addBtn);
        }

        function handleTabClick(id, isActive) {
            if (isActive) return; // Ne rien faire si d√©j√† actif
            
            // Sauvegarder l'√©tat actuel avant de changer
            autoSaveCurrentProfile();
            binderData.activeId = id;
            saveBinderData();
            renderTabs();
            loadProfile(id);
        }

        function createNewProfile() {
            const newId = 'p_' + Date.now();
            
            // Sauvegarder l'actuel avant de switcher
            autoSaveCurrentProfile();

            // Cr√©ation directe sans popup
            binderData.profiles[newId] = { name: "Nouveau", data: {} };
            binderData.activeId = newId;
            saveBinderData();
            
            renderTabs();
            // Reset visuel pour le nouveau
            resetSheet(false); // false = ne pas effacer le stockage, juste les inputs visuels
            // Initialisation du nom
            document.getElementById('char-name').value = "Nouveau";
            // Et on save direct ce nouvel √©tat
            autoSaveCurrentProfile();
        }

        function deleteCurrentProfile() {
            // Emp√™cher la suppression s'il n'y en a qu'un
            if (Object.keys(binderData.profiles).length <= 1) {
                // Optionnel : vider la fiche au lieu de supprimer ?
                // Le user a demand√© "effacer la fiche compl√®te".
                // On peut proposer un reset √† la place.
                if(confirm("C'est votre derni√®re fiche. Voulez-vous la vider compl√©tement ?")) {
                   resetSheet(true);
                   document.getElementById('char-name').value = "Nouveau";
                   autoSaveCurrentProfile();
                }
                return;
            }

            const currentName = binderData.profiles[binderData.activeId].name;
            if (!confirm(`Voulez-vous vraiment supprimer d√©finitivement "${currentName}" ?`)) return;

            const idToDelete = binderData.activeId;
            delete binderData.profiles[idToDelete];

            // Switcher sur un autre profil (le premier dispo)
            binderData.activeId = Object.keys(binderData.profiles)[0];
            
            saveBinderData();
            renderTabs();
            loadProfile(binderData.activeId);
        }

        // -----------------------------------------------------
        // --- FONCTIONS EXPORT / IMPORT (SAUVEGARDE FICHIER) ---
        // -----------------------------------------------------

        function exportBackup() {
            // 1. Assurer que l'√©tat actuel est sauvegard√© dans l'objet global
            autoSaveCurrentProfile();

            // 2. Cr√©er l'objet JSON complet (tous les profils)
            const dataStr = JSON.stringify(binderData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            // 3. Cr√©er un lien temporaire pour le t√©l√©chargement
            const a = document.createElement('a');
            a.href = url;
            // Nom du fichier avec date
            const date = new Date().toISOString().split('T')[0];
            a.download = `sccs_backup_${date}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function triggerImport() {
            // D√©clenche le clic sur l'input file cach√©
            document.getElementById('file-upload').click();
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validation basique
                    if (!importedData.profiles || !importedData.activeId) {
                        alert("Erreur : Ce fichier ne semble pas √™tre une sauvegarde valide.");
                        return;
                    }

                    if (confirm("ATTENTION : Charger un fichier va REMPLACER tous les personnages actuels par ceux du fichier.\n\nVoulez-vous continuer ?")) {
                        binderData = importedData;
                        saveBinderData(); // Met √† jour le localStorage
                        renderTabs();
                        loadProfile(binderData.activeId);
                        alert("Sauvegarde charg√©e avec succ√®s !");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Erreur lors de la lecture du fichier : " + err.message);
                }
            };
            reader.readAsText(file);
            
            // Reset l'input pour permettre de recharger le m√™me fichier si besoin
            input.value = ''; 
        }

        // --- SYST√àME DE S√âRIALISATION DES DONN√âES ---

        function autoSaveCurrentProfile() {
            if (!binderData.activeId) return;
            const data = {};
            
            // Inputs avec ID
            document.querySelectorAll('input[id], select[id], textarea[id]').forEach(el => {
                if (el.type === 'checkbox') data[el.id] = el.checked;
                else data[el.id] = el.value;
            });
            
            // Inputs sans ID
            document.querySelectorAll('.clean-input:not([id])').forEach((el, index) => {
                data[`__clean_input_${index}`] = el.value;
            });
             document.querySelectorAll('.area-textarea:not([id])').forEach((el, index) => {
                data[`__area_${index}`] = el.value;
            });

            // Ajout du state (talents)
            data.__state_talents = state.talents;

            binderData.profiles[binderData.activeId].data = data;
             // Update nom pour l'onglet
            const nameVal = document.getElementById('char-name').value;
            // On met √† jour le nom si pr√©sent, sinon on garde "Nouveau" ou l'ancien
            if (nameVal) binderData.profiles[binderData.activeId].name = nameVal;
            else binderData.profiles[binderData.activeId].name = "Sans nom";
            
            // Optimisation: ne pas re-rendre les onglets √† chaque frappe, juste si le nom change
            const currentTabName = document.querySelector('.binder-tab.active')?.innerText;
            if (binderData.profiles[binderData.activeId].name !== currentTabName) {
                renderTabs();
            }

            saveBinderData();
        }

        function updateProfileName(val) {
            autoSaveCurrentProfile();
        }

        function loadProfile(id) {
            const profile = binderData.profiles[id];
            if (!profile) return;
            
            // 1. Reset visuel complet
            document.querySelectorAll('input, textarea').forEach(el => el.value = '');
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
            if(document.getElementById('weapon-select')) document.getElementById('weapon-select').value = "Mains Nues";
            document.querySelectorAll('input[type=number]').forEach(el => el.value = '0');

            const data = profile.data || {};

            if (!data['weapon-select']) {
                 data['weapon-select'] = "Mains Nues";
           }

            // 2. Remplir
            Object.keys(data).forEach(key => {
                if (key.startsWith('__clean_input_')) {
                    const idx = parseInt(key.replace('__clean_input_', ''));
                    const els = document.querySelectorAll('.clean-input:not([id])');
                    if (els[idx]) els[idx].value = data[key];
                } 
                else if (key.startsWith('__area_')) {
                    const idx = parseInt(key.replace('__area_', ''));
                    const els = document.querySelectorAll('.area-textarea:not([id])');
                    if (els[idx]) els[idx].value = data[key];
                }
                else {
                    const el = document.getElementById(key);
                    if (el) {
                        if (el.type === 'checkbox') el.checked = data[key];
                        else el.value = data[key];
                    }
                }
            });

            // 3. Restaurer le state
            if (data.__state_talents) {
                state.talents = JSON.parse(JSON.stringify(data.__state_talents));
            } else {
                updateRace(); // Fallback
            }

            // Trigger updates
            // initWeaponSelect(); 
            updateOffhandOptions();
            updateUI();
            updatePortrait();
        }

        function resetSheet(clearStorage = true) {
            if (clearStorage && !confirm("Voulez-vous vraiment vider tous les champs de ce personnage ?")) return;

            // Vider inputs
            document.querySelectorAll('input, textarea').forEach(el => el.value = '');
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
            if(document.getElementById('weapon-select')) document.getElementById('weapon-select').value = "Mains Nues";
            document.querySelectorAll('input[type=number]').forEach(el => el.value = '0');
            
            // Reset state
            state.talents = {
                athletisme: false, acrobatie: false, mecanique: false,
                subtilite: false, perception: false, survie: false,
                savoir_acad: false
            };
            
            updateUI();
            updatePortrait();

            if (clearStorage) autoSaveCurrentProfile();
        }

        // --- FIN SYSTEME BINDER ---


        // Base de donn√©es des armes (Livret 3)
        const WEAPONS_DATA = {
            "Distance": {
                label: "Armes √† Distance",
                stats: { init: "1/7", magie: -1 },
                items: ["Arc", "Arbal√®te", "Fronde"]
            },
            "Focalisateur": {
                label: "Focalisateurs",
                stats: { init: "2/8", magie: 0 },
                items: ["Grimoire", "Chapelet", "B√¢ton"]
            },
            "Longue": {
                label: "Armes Longues (2 mains)",
                stats: { init: "4", magie: -1 },
                items: ["Lance (Longue)", "√âp√©e √† deux mains", "Hache √† deux mains", "Masse √† deux mains"]
            },
            "Moyenne": {
                label: "Armes Moyennes (1 main)",
                stats: { init: "5", magie: -1 },
                items: ["√âp√©e", "Hache", "Masse", "Lance (1 main)", "Fl√©au"]
            },
            "Courte": {
                label: "Armes Courtes",
                stats: { init: "6", magie: -1 },
                items: ["Dague", "√âp√©e courte", "Torche", "Mains Nues"]
            }
        };

        // R√®gles compl√®tes
        const RULES = {
            ARMORS: {
                "Aucune": { dur: 0, res: 0, malus: [] },
                "L√©g√®re": { dur: 6, res: 1, malus: ["acrobatie", "athletisme", "magie"] },
                "L√©g√®re_Heaume": { dur: 6, res: 1, malus: ["acrobatie", "athletisme", "magie", "perception", "acrobatie"] }, 
                "Moyenne": { dur: 8, res: 2, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "magie"] },
                "Moyenne_Heaume": { dur: 8, res: 2, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "magie", "perception", "acrobatie"] },
                "Lourde": { dur: 10, res: 3, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "perception", "magie"] },
                "Lourde_Heaume": { dur: 10, res: 3, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "perception", "magie", "perception", "acrobatie"] } 
            },
            RACES: {
                "ELFE": ["acrobatie", "perception", "survie"],
                "NAIN": ["athletisme", "mecanique", "savoir_acad"],
                "ORQUE": ["athletisme", "survie"],
                "HUMAIN": []
            }
        };

        const talentsList = [
            { id: 'athletisme', label: 'Athl√©tisme' },
            { id: 'acrobatie', label: 'Acrobatie' },
            { id: 'mecanique', label: 'M√©canique' },
            { id: 'subtilite', label: 'Subtilit√©' },
            { id: 'perception', label: 'Perception' },
            { id: 'survie', label: 'Survie' },
            { id: 'savoir_acad', label: 'Savoir Acad.' }
        ];

        function initWeaponSelect() {
            const select = document.getElementById('weapon-select');
            if (!select) return;
            select.innerHTML = '';
            
            for (const [key, category] of Object.entries(WEAPONS_DATA)) {
                const group = document.createElement('optgroup');
                group.label = category.label;
                group.dataset.categoryKey = key; 
                
                category.items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    option.dataset.category = key;
                    group.appendChild(option);
                });
                select.appendChild(group);
            }
            select.value = "Mains Nues";
            updateUI();
        }

        function getWeaponStats(weaponName) {
            for (const [key, category] of Object.entries(WEAPONS_DATA)) {
                if (category.items.includes(weaponName)) {
                    return category.stats;
                }
            }
            return { init: "-", magie: 0 };
        }

        function getWeaponCategory(weaponName) {
            for (const [key, category] of Object.entries(WEAPONS_DATA)) {
                if (category.items.includes(weaponName)) {
                    return key;
                }
            }
            return "Courte";
        }

        function updateOffhandOptions() {
            const weaponSelect = document.getElementById('weapon-select');
            const offhandSelect = document.getElementById('offhand-select');
            
            if (!weaponSelect || !offhandSelect) return;

            const weaponName = weaponSelect.value;
            const category = getWeaponCategory(weaponName);
            const currentOffhand = offhandSelect.value;
            
            offhandSelect.innerHTML = ''; 
            offhandSelect.disabled = false;
            
            let options = [];

            if (category === "Distance" || category === "Longue") {
                options.push("Occup√©e (2 mains)");
                offhandSelect.disabled = true; 
            } 
            else if (category === "Focalisateur") {
                options.push("Main Libre (Incantation)");
            }
            else if (category === "Moyenne") {
                options.push("Main Libre");
                options.push("Bouclier");
                options.push("Torche");
            }
            else { 
                options.push("Main Libre");
                options.push("Bouclier");
                options.push("Torche");
                const shortWeapons = WEAPONS_DATA["Courte"].items;
                shortWeapons.forEach(wp => {
                    if (wp !== "Mains Nues" && wp !== "Torche" && wp !== "Bouclier (Offensif)") {
                        options.push(wp); 
                    }
                });
            }

            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.textContent = opt;
                offhandSelect.appendChild(el);
            });

            if (Array.from(offhandSelect.options).some(o => o.value === currentOffhand)) {
                offhandSelect.value = currentOffhand;
            } else {
                offhandSelect.selectedIndex = 0;
            }
        }

        function updatePortrait() {
            const raceEl = document.getElementById('race-select');
            const genderEl = document.getElementById('gender-select');
            
            if (!raceEl || !genderEl) return;

            const race = raceEl.value;
            const gender = genderEl.value;
            const container = document.getElementById('portrait-container');
            const key = `${race}_${gender}`;

            if (CUSTOM_PORTRAITS_URLS[key]) {
                container.innerHTML = `<img src="${CUSTOM_PORTRAITS_URLS[key]}" class="portrait-img-custom" alt="Portrait">`;
            } else {
            container.innerHTML = `<div style="text-transform:uppercase; font-size:10px; font-weight:bold; letter-spacing:0.1em; color:rgba(28, 25, 23, 0.8);">PORTRAIT</div>`;
        }

        function updateRace() {
            const raceEl = document.getElementById('race-select');
            if (!raceEl) return;

            const race = raceEl.value;
            Object.keys(state.talents).forEach(k => state.talents[k] = false);
            if (RULES.RACES[race]) {
                RULES.RACES[race].forEach(tid => state.talents[tid] = true);
            }
            
            const saisieField = document.getElementById('stat-att-saisie');
            if(saisieField) saisieField.value = (race === "ORQUE") ? 1 : 0;
            
            autoSaveCurrentProfile();
            updateUI();
        }

        function toggleTalent(id) {
            state.talents[id] = !state.talents[id];
            autoSaveCurrentProfile(); 
            updateUI();
        }

        function updateUI() {
            const weaponSelect = document.getElementById('weapon-select');
            if (!weaponSelect) return;
            
            const weaponName = weaponSelect.value;
            const currentCat = getWeaponCategory(weaponName);
            
            if (state.currentWeaponCategory !== currentCat || document.activeElement === weaponSelect) {
                state.currentWeaponCategory = currentCat;
                updateOffhandOptions();
            }

            const armorEl = document.getElementById('armor-select');
            const offhandEl = document.getElementById('offhand-select');
            
            if (!armorEl || !offhandEl) return;

            const armor = armorEl.value;
            const armorData = RULES.ARMORS[armor];
            const baseRes = armorData ? armorData.res : 0;
            const headRes = armor.includes("_Heaume") ? baseRes : 0;
            
            const elResTete = document.getElementById('res-arm-tete');
            const elResTronc = document.getElementById('res-arm-tronc');
            const elResMembres = document.getElementById('res-arm-membres');

            if (elResTete) elResTete.innerText = headRes;
            if (elResTronc) elResTronc.innerText = baseRes;
            if (elResMembres) elResMembres.innerText = baseRes;

            const weaponStats = getWeaponStats(weaponName);
            const initSpan = document.getElementById('init-val');
            if (initSpan) {
                const rawInit = weaponStats.init;

                if (rawInit.includes('/')) {
                    const [v1, v2] = rawInit.split('/');
                    initSpan.classList.remove('stat-digit'); 
                    initSpan.className = "font-digit font-bold text-stone-900"; 
                    initSpan.innerHTML = `
                        <span style="font-size:1.4rem;">${v1}</span><span style="font-size:0.5rem; vertical-align:middle; margin-left:1px; margin-right:3px; font-family: 'Cinzel', serif;">LIBRE</span>
                        <span style="font-size:1.1rem; color:#78716c;">/</span>
                        <span style="font-size:1.4rem; margin-left:3px;">${v2}</span><span style="font-size:0.5rem; vertical-align:middle; margin-left:1px; font-family: 'Cinzel', serif;">ENGAG√â</span>
                    `;
                } else {
                    initSpan.className = "stat-digit"; 
                    initSpan.style.color = "#0f0a05";
                    initSpan.innerHTML = rawInit;
                }
            }
            
            const magicWeaponText = document.getElementById('magic-weapon-text');
            const magicWeaponVal = document.getElementById('magie-arme-val');
            const rowMalusArmure = document.getElementById('row-malus-armure'); 
            const malusArme = weaponStats.magie;

            if (magicWeaponText && magicWeaponVal && rowMalusArmure) {
                if (weaponName === "Mains Nues") {
                    magicWeaponText.innerHTML = '<span class="font-black text-stone-900 text-xs">PAS DE FOCALISATEUR,<br>IMPOSSIBLE DE LANCER DES SORTS</span>';
                    magicWeaponVal.style.visibility = 'hidden'; 
                    rowMalusArmure.style.visibility = 'hidden'; 
                } else {
                    rowMalusArmure.style.visibility = 'visible';
                    magicWeaponVal.style.visibility = 'visible';
                    
                    if (currentCat === "Focalisateur") {
                        magicWeaponText.innerText = "Utilisation d'un focalisateur (pas de malus)";
                        magicWeaponVal.innerText = "0";
                    } else {
                        magicWeaponText.innerText = "Focalisateur partiel";
                        magicWeaponVal.innerText = malusArme; 
                    }
                }
            }

            let malusArmure = 0;
            if (armorData && armorData.malus && armorData.malus.includes("magie")) {
                malusArmure = -1; 
            }
            const elMagieArmureVal = document.getElementById('magie-armure-val');
            if (elMagieArmureVal) elMagieArmureVal.innerText = (malusArmure >= 0 ? "+" : "") + malusArmure;

            const maxDur = armorData ? armorData.dur : 0;
            const elDur = document.getElementById('dur-display');
            if (elDur) elDur.innerHTML = `<span class="font-digit">${maxDur}</span>/<span class="font-digit">${maxDur}</span>`;

            const container = document.getElementById('talents-container');
            if (container) {
                let html = '<table style="width:100%; border-collapse:collapse;">';
                
                talentsList.forEach(t => {
                    let score = state.talents[t.id] ? 1 : 0;
                    if (armorData && armorData.malus) {
                        const malusCount = armorData.malus.filter(m => m === t.id).length;
                        score -= malusCount;
                    }

                    const isChecked = state.talents[t.id];
                    const colorClass = score < 0 ? 'text-red-900' : 'text-stone-900';
                    
                    html += `
                    <tr style="cursor:pointer;" onclick="toggleTalent('${t.id}')" onmouseover="this.style.backgroundColor='rgba(0,0,0,0.05)'" onmouseout="this.style.backgroundColor='transparent'">
                        <td style="padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.2); vertical-align:middle;">
                            <div class="check-box ${isChecked ? 'active' : ''}" style="width:16px; height:16px; margin:0 10px 0 0; vertical-align:middle;"></div>
                            <span style="font-weight:700; text-transform:uppercase; font-size:0.85rem; color:#1a1a1a; vertical-align:middle;">${t.label}</span>
                        </td>
                        <td style="padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.2); text-align:right; font-weight:700; font-size:1.5rem; vertical-align:middle; font-family: 'Spectral', serif;" class="${colorClass}">${score >= 0 ? '+' : ''}${score}</td>
                    </tr>
                    `;
                });
                html += '</table>';
                container.innerHTML = html;
            }
        }

        window.onload = function() {
            try {
                initWeaponSelect();
                updateOffhandOptions(); 
                initBinder();
            } catch (e) {
                console.error("Erreur d'initialisation:", e);
            }
        };
    </script>
</body>

</html>



